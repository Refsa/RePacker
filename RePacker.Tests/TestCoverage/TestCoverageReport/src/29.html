<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker\Generator\Generators\HashSetGenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Reflection;
using System.Reflection.Emit;
using RePacker.Buffers;
using RePacker.Utils;
using static RePacker.Builder.PackerCollectionsExt;

namespace RePacker.Builder
{
    internal class HashSetGenerator : IGenerator
    {
        public GeneratorType GeneratorType =&gt; GeneratorType.Object;
        public Type ForType =&gt; typeof(HashSet&lt;&gt;);

        MethodInfo deserializeHashSetMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.UnpackHashSet));
        // MethodInfo deserializeHashSetBlittableMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.UnpackHashSetBlittable));

        MethodInfo serializeHashSetMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.PackHashSet));
        // MethodInfo serializeHashSetBlittableMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.PackHashSetBlittable));

        public void GenerateDeserializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            Type elementType = fieldInfo.FieldType.GenericTypeArguments[0];

            ilGen.Emit(OpCodes.Ldarg_0);

            ilGen.Emit(OpCodes.Ldloca_S, 0);
            ilGen.Emit(OpCodes.Ldflda, fieldInfo);

            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo))
            {
                var enumerableDeserializer = deserializeHashSetMethod.MakeGenericMethod(elementType);
                ilGen.Emit(OpCodes.Call, enumerableDeserializer);
            }
            // else if (elementType.IsValueType || (elementType.IsStruct() &amp;&amp; elementType.IsUnmanagedStruct()))
            // {
            //     var enumerableDeserializer = deserializeHashSetBlittableMethod.MakeGenericMethod(elementType);
            //     ilGen.Emit(OpCodes.Call, enumerableDeserializer);
            // }
            else
            {
                ilGen.Emit(OpCodes.Pop);
                ilGen.Emit(OpCodes.Pop);
                ilGen.EmitLog($&quot;RePacker - Unpack: Array of type {fieldInfo.FieldType.Name} is not supported&quot;);
                return;
            }
        }

        public void GenerateSerializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            ilGen.Emit(OpCodes.Ldarg_0);

            ilGen.Emit(OpCodes.Ldarga_S, 1);
            ilGen.Emit(OpCodes.Ldfld, fieldInfo);

            Type elementType = fieldInfo.FieldType.GenericTypeArguments[0];
            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo))
            {
                var enumerableSerializer = serializeHashSetMethod.MakeGenericMethod(elementType);
                ilGen.Emit(OpCodes.Call, enumerableSerializer);
            }
            // else if (elementType.IsValueType || (elementType.IsStruct() &amp;&amp; elementType.IsUnmanagedStruct()))
            // {
            //     var enumerableSerializer = serializeHashSetBlittableMethod.MakeGenericMethod(elementType);
            //     ilGen.Emit(OpCodes.Call, enumerableSerializer);
            // }
            else
            {
                ilGen.Emit(OpCodes.Pop);
                ilGen.Emit(OpCodes.Pop);
                ilGen.EmitLog($&quot;RePacker - Pack: HashSet of type {fieldInfo.FieldType.Name} is not supported&quot;);
            }
        }

        public void GenerateGetSizer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            var elementType = fieldInfo.FieldType.GetElementType();

            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo) &amp;&amp; !typeInfo.IsDirectlyCopyable)
            {
                var sizeMethod = typeof(PackerCollectionsExt)
                    .GetMethod(nameof(PackerCollectionsExt.SizeOfColleciton))
                    .MakeGenericMethod(elementType);

                ilGen.Emit(OpCodes.Ldarg_0);
                ilGen.Emit(OpCodes.Call, fieldInfo.FieldType.GetMethod(&quot;GetEnumerator&quot;));
                ilGen.Emit(OpCodes.Call, sizeMethod);
            }
            else
            {
                ilGen.Emit(OpCodes.Ldc_I4, 0);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,47,13,67,0],[13,47,13,67,0],[13,47,13,67,0],[13,47,13,67,0],[13,47,13,67,0],[14,32,14,49,0],[14,32,14,49,0],[14,32,14,49,0],[14,32,14,49,0],[14,32,14,49,0],[16,9,16,130,1],[16,9,16,130,1],[16,9,16,130,1],[16,9,16,130,1],[16,9,16,130,1],[19,9,19,126,1],[19,9,19,126,1],[19,9,19,126,1],[19,9,19,126,1],[19,9,19,126,1],[23,9,23,10,0],[23,9,23,10,0],[23,9,23,10,0],[23,9,23,10,0],[23,9,23,10,0],[24,13,24,76,0],[24,13,24,76,0],[24,13,24,76,0],[24,13,24,76,0],[24,13,24,76,0],[26,13,26,41,0],[26,13,26,41,0],[26,13,26,41,0],[26,13,26,41,0],[26,13,26,41,0],[28,13,28,45,0],[28,13,28,45,0],[28,13,28,45,0],[28,13,28,45,0],[28,13,28,45,0],[29,13,29,51,0],[29,13,29,51,0],[29,13,29,51,0],[29,13,29,51,0],[29,13,29,51,0],[31,13,31,73,0],[31,13,31,73,0],[31,13,31,73,0],[31,13,31,73,0],[31,13,31,73,0],[32,13,32,14,0],[32,13,32,14,0],[32,13,32,14,0],[32,13,32,14,0],[32,13,32,14,0],[33,17,33,102,0],[33,17,33,102,0],[33,17,33,102,0],[33,17,33,102,0],[33,17,33,102,0],[34,17,34,66,0],[34,17,34,66,0],[34,17,34,66,0],[34,17,34,66,0],[34,17,34,66,0],[35,13,35,14,0],[35,13,35,14,0],[35,13,35,14,0],[35,13,35,14,0],[35,13,35,14,0],[42,13,42,14,0],[42,13,42,14,0],[42,13,42,14,0],[42,13,42,14,0],[42,13,42,14,0],[43,17,43,41,0],[43,17,43,41,0],[43,17,43,41,0],[43,17,43,41,0],[43,17,43,41,0],[44,17,44,41,0],[44,17,44,41,0],[44,17,44,41,0],[44,17,44,41,0],[44,17,44,41,0],[45,17,45,112,0],[45,17,45,112,0],[45,17,45,112,0],[45,17,45,112,0],[45,17,45,112,0],[46,17,46,24,0],[46,17,46,24,0],[46,17,46,24,0],[46,17,46,24,0],[46,17,46,24,0],[48,9,48,10,0],[48,9,48,10,0],[48,9,48,10,0],[48,9,48,10,0],[48,9,48,10,0],[51,9,51,10,0],[51,9,51,10,0],[51,9,51,10,0],[51,9,51,10,0],[51,9,51,10,0],[52,13,52,41,0],[52,13,52,41,0],[52,13,52,41,0],[52,13,52,41,0],[52,13,52,41,0],[54,13,54,45,0],[54,13,54,45,0],[54,13,54,45,0],[54,13,54,45,0],[54,13,54,45,0],[55,13,55,50,0],[55,13,55,50,0],[55,13,55,50,0],[55,13,55,50,0],[55,13,55,50,0],[57,13,57,76,0],[57,13,57,76,0],[57,13,57,76,0],[57,13,57,76,0],[57,13,57,76,0],[58,13,58,73,0],[58,13,58,73,0],[58,13,58,73,0],[58,13,58,73,0],[58,13,58,73,0],[59,13,59,14,0],[59,13,59,14,0],[59,13,59,14,0],[59,13,59,14,0],[59,13,59,14,0],[60,17,60,98,0],[60,17,60,98,0],[60,17,60,98,0],[60,17,60,98,0],[60,17,60,98,0],[61,17,61,64,0],[61,17,61,64,0],[61,17,61,64,0],[61,17,61,64,0],[61,17,61,64,0],[62,13,62,14,0],[62,13,62,14,0],[62,13,62,14,0],[62,13,62,14,0],[62,13,62,14,0],[69,13,69,14,0],[69,13,69,14,0],[69,13,69,14,0],[69,13,69,14,0],[69,13,69,14,0],[70,17,70,41,0],[70,17,70,41,0],[70,17,70,41,0],[70,17,70,41,0],[70,17,70,41,0],[71,17,71,41,0],[71,17,71,41,0],[71,17,71,41,0],[71,17,71,41,0],[71,17,71,41,0],[72,17,72,112,0],[72,17,72,112,0],[72,17,72,112,0],[72,17,72,112,0],[72,17,72,112,0],[73,13,73,14,0],[73,13,73,14,0],[73,13,73,14,0],[73,13,73,14,0],[73,13,73,14,0],[74,9,74,10,0],[74,9,74,10,0],[74,9,74,10,0],[74,9,74,10,0],[74,9,74,10,0],[77,9,77,10,0],[77,9,77,10,0],[77,9,77,10,0],[77,9,77,10,0],[77,9,77,10,0],[78,13,78,68,0],[78,13,78,68,0],[78,13,78,68,0],[78,13,78,68,0],[78,13,78,68,0],[80,13,80,105,0],[80,13,80,105,0],[80,13,80,105,0],[80,13,80,105,0],[80,13,80,105,0],[81,13,81,14,0],[81,13,81,14,0],[81,13,81,14,0],[81,13,81,14,0],[81,13,81,14,0],[82,17,84,53,0],[82,17,84,53,0],[82,17,84,53,0],[82,17,84,53,0],[82,17,84,53,0],[86,17,86,45,0],[86,17,86,45,0],[86,17,86,45,0],[86,17,86,45,0],[86,17,86,45,0],[87,17,87,90,0],[87,17,87,90,0],[87,17,87,90,0],[87,17,87,90,0],[87,17,87,90,0],[88,17,88,54,0],[88,17,88,54,0],[88,17,88,54,0],[88,17,88,54,0],[88,17,88,54,0],[89,13,89,14,0],[89,13,89,14,0],[89,13,89,14,0],[89,13,89,14,0],[89,13,89,14,0],[91,13,91,14,0],[91,13,91,14,0],[91,13,91,14,0],[91,13,91,14,0],[91,13,91,14,0],[92,17,92,47,0],[92,17,92,47,0],[92,17,92,47,0],[92,17,92,47,0],[92,17,92,47,0],[93,13,93,14,0],[93,13,93,14,0],[93,13,93,14,0],[93,13,93,14,0],[93,13,93,14,0],[94,9,94,10,0],[94,9,94,10,0],[94,9,94,10,0],[94,9,94,10,0],[94,9,94,10,0]]);
    </script>
  </body>
</html>