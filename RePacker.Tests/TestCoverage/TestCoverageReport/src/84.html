<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker.Unsafe\Buffer\BufferUtils.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Runtime.CompilerServices;
using RePacker.Unsafe;

namespace RePacker.Buffers
{
    public static class BufferUtils
    {
        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static unsafe void Pack&lt;T&gt;(this Buffer buffer, ref T value)
            where T : unmanaged
        {
            if (!buffer.CanWrite&lt;T&gt;())
            {
                throw new IndexOutOfRangeException($&quot;Trying to write type {typeof(T)} outside of range of buffer&quot;);
            }

            fixed (byte* data = &amp;buffer.Array[buffer.WriteCursor()])
            {
                *((T*)data) = value;
            }

            buffer.MoveWriteCursor(sizeof(T));
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static unsafe void Unpack&lt;T&gt;(this Buffer buffer, out T value)
            where T : unmanaged
        {
            if (!buffer.CanRead&lt;T&gt;())
            {
                throw new IndexOutOfRangeException($&quot;Trying to read type {typeof(T)} outside of range of buffer&quot;);
            }

            fixed (byte* data = &amp;buffer.Array[buffer.ReadCursor()])
            {
                value = *(T*)data;
            }

            buffer.MoveReadCursor(sizeof(T));
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static unsafe T Peek&lt;T&gt;(this Buffer buffer, int offset = 0)
            where T : unmanaged
        {
            if (buffer.ReadCursor() + offset + sizeof(T) &gt; buffer.Array.Length)
            {
                throw new IndexOutOfRangeException($&quot;Trying to read type {typeof(T)} outside of range of buffer&quot;);
            }

            fixed (byte* data = &amp;buffer.Array[buffer.ReadCursor() + offset])
            {
                return *(T*)data;
            }
        }

        public static unsafe void PackArray&lt;T&gt;(this Buffer buffer, T[] array, int offset = 0, int length = 0)
            where T : unmanaged
        {
            if (array == null || (length == 0 &amp;&amp; array.Length == 0))
            {
                ulong zero = 0;
                buffer.Pack(ref zero);
                return;
            }
            if (length == 0) length = array.Length;

            if (!buffer.CanWrite&lt;T&gt;(length))
            {
                throw new IndexOutOfRangeException();
            }

            ulong len = (ulong)length;
            buffer.Pack(ref len);

            int pos = buffer.WriteCursor();
            int size = UnsafeUtils.SizeOf&lt;T&gt;();

            fixed (void* src = &amp;array[offset], dest = &amp;buffer.Array[pos])
            {
                System.Buffer.MemoryCopy(src, dest, length * size, length * size);
            }

            buffer.MoveWriteCursor(length * size);
        }

        public static unsafe T[] UnpackArray&lt;T&gt;(this Buffer buffer)
            where T : unmanaged
        {
            buffer.Unpack(out ulong len);

            T[] destArray = new T[(int)len];

            if (len == 0 || !buffer.CanRead&lt;T&gt;((int)len))
            {
                return destArray;
            }

            int size = UnsafeUtils.SizeOf&lt;T&gt;();

            fixed (void* src = &amp;buffer.Array[buffer.ReadCursor()], dest = destArray)
            {
                System.Buffer.MemoryCopy(src, dest, len * (ulong)size, len * (ulong)size);
            }

            buffer.MoveReadCursor(size * (int)len);

            return destArray;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,9,12,10,1],[12,9,12,10,1],[12,9,12,10,1],[12,9,12,10,1],[12,9,12,10,1],[13,13,13,39,1],[13,13,13,39,1],[13,13,13,39,1],[13,13,13,39,1],[13,13,13,39,1],[14,13,14,14,1],[14,13,14,14,1],[14,13,14,14,1],[14,13,14,14,1],[14,13,14,14,1],[15,17,15,116,1],[15,17,15,116,1],[15,17,15,116,1],[15,17,15,116,1],[15,17,15,116,1],[18,20,18,68,1],[18,20,18,68,1],[18,20,18,68,1],[18,20,18,68,1],[18,20,18,68,1],[19,13,19,14,1],[19,13,19,14,1],[19,13,19,14,1],[19,13,19,14,1],[19,13,19,14,1],[20,17,20,37,1],[20,17,20,37,1],[20,17,20,37,1],[20,17,20,37,1],[20,17,20,37,1],[21,13,21,14,1],[21,13,21,14,1],[21,13,21,14,1],[21,13,21,14,1],[21,13,21,14,1],[23,13,23,47,1],[23,13,23,47,1],[23,13,23,47,1],[23,13,23,47,1],[23,13,23,47,1],[24,9,24,10,1],[24,9,24,10,1],[24,9,24,10,1],[24,9,24,10,1],[24,9,24,10,1],[29,9,29,10,1],[29,9,29,10,1],[29,9,29,10,1],[29,9,29,10,1],[29,9,29,10,1],[30,13,30,38,1],[30,13,30,38,1],[30,13,30,38,1],[30,13,30,38,1],[30,13,30,38,1],[31,13,31,14,0],[31,13,31,14,0],[31,13,31,14,0],[31,13,31,14,0],[31,13,31,14,0],[32,17,32,115,0],[32,17,32,115,0],[32,17,32,115,0],[32,17,32,115,0],[32,17,32,115,0],[35,20,35,67,1],[35,20,35,67,1],[35,20,35,67,1],[35,20,35,67,1],[35,20,35,67,1],[36,13,36,14,1],[36,13,36,14,1],[36,13,36,14,1],[36,13,36,14,1],[36,13,36,14,1],[37,17,37,35,1],[37,17,37,35,1],[37,17,37,35,1],[37,17,37,35,1],[37,17,37,35,1],[38,13,38,14,1],[38,13,38,14,1],[38,13,38,14,1],[38,13,38,14,1],[38,13,38,14,1],[40,13,40,46,1],[40,13,40,46,1],[40,13,40,46,1],[40,13,40,46,1],[40,13,40,46,1],[41,9,41,10,1],[41,9,41,10,1],[41,9,41,10,1],[41,9,41,10,1],[41,9,41,10,1],[46,9,46,10,0],[46,9,46,10,0],[46,9,46,10,0],[46,9,46,10,0],[46,9,46,10,0],[47,13,47,80,0],[47,13,47,80,0],[47,13,47,80,0],[47,13,47,80,0],[47,13,47,80,0],[48,13,48,14,0],[48,13,48,14,0],[48,13,48,14,0],[48,13,48,14,0],[48,13,48,14,0],[49,17,49,115,0],[49,17,49,115,0],[49,17,49,115,0],[49,17,49,115,0],[49,17,49,115,0],[52,20,52,76,0],[52,20,52,76,0],[52,20,52,76,0],[52,20,52,76,0],[52,20,52,76,0],[53,13,53,14,0],[53,13,53,14,0],[53,13,53,14,0],[53,13,53,14,0],[53,13,53,14,0],[54,17,54,34,0],[54,17,54,34,0],[54,17,54,34,0],[54,17,54,34,0],[54,17,54,34,0],[56,9,56,10,0],[56,9,56,10,0],[56,9,56,10,0],[56,9,56,10,0],[56,9,56,10,0],[60,9,60,10,1],[60,9,60,10,1],[60,9,60,10,1],[60,9,60,10,1],[60,9,60,10,1],[61,13,61,69,1],[61,13,61,69,1],[61,13,61,69,1],[61,13,61,69,1],[61,13,61,69,1],[62,13,62,14,1],[62,13,62,14,1],[62,13,62,14,1],[62,13,62,14,1],[62,13,62,14,1],[63,17,63,32,1],[63,17,63,32,1],[63,17,63,32,1],[63,17,63,32,1],[63,17,63,32,1],[64,17,64,39,1],[64,17,64,39,1],[64,17,64,39,1],[64,17,64,39,1],[64,17,64,39,1],[65,17,65,24,1],[65,17,65,24,1],[65,17,65,24,1],[65,17,65,24,1],[65,17,65,24,1],[67,13,67,29,1],[67,13,67,29,1],[67,13,67,29,1],[67,13,67,29,1],[67,13,67,29,1],[67,30,67,52,1],[67,30,67,52,1],[67,30,67,52,1],[67,30,67,52,1],[67,30,67,52,1],[69,13,69,45,1],[69,13,69,45,1],[69,13,69,45,1],[69,13,69,45,1],[69,13,69,45,1],[70,13,70,14,0],[70,13,70,14,0],[70,13,70,14,0],[70,13,70,14,0],[70,13,70,14,0],[71,17,71,54,0],[71,17,71,54,0],[71,17,71,54,0],[71,17,71,54,0],[71,17,71,54,0],[74,13,74,39,1],[74,13,74,39,1],[74,13,74,39,1],[74,13,74,39,1],[74,13,74,39,1],[75,13,75,34,1],[75,13,75,34,1],[75,13,75,34,1],[75,13,75,34,1],[75,13,75,34,1],[77,13,77,44,1],[77,13,77,44,1],[77,13,77,44,1],[77,13,77,44,1],[77,13,77,44,1],[78,13,78,48,1],[78,13,78,48,1],[78,13,78,48,1],[78,13,78,48,1],[78,13,78,48,1],[80,20,80,46,1],[80,20,80,46,1],[80,20,80,46,1],[80,20,80,46,1],[80,20,80,46,1],[80,48,80,73,1],[80,48,80,73,1],[80,48,80,73,1],[80,48,80,73,1],[80,48,80,73,1],[81,13,81,14,1],[81,13,81,14,1],[81,13,81,14,1],[81,13,81,14,1],[81,13,81,14,1],[82,17,82,83,1],[82,17,82,83,1],[82,17,82,83,1],[82,17,82,83,1],[82,17,82,83,1],[83,13,83,14,1],[83,13,83,14,1],[83,13,83,14,1],[83,13,83,14,1],[83,13,83,14,1],[85,13,85,51,1],[85,13,85,51,1],[85,13,85,51,1],[85,13,85,51,1],[85,13,85,51,1],[86,9,86,10,1],[86,9,86,10,1],[86,9,86,10,1],[86,9,86,10,1],[86,9,86,10,1],[90,9,90,10,1],[90,9,90,10,1],[90,9,90,10,1],[90,9,90,10,1],[90,9,90,10,1],[91,13,91,42,1],[91,13,91,42,1],[91,13,91,42,1],[91,13,91,42,1],[91,13,91,42,1],[93,13,93,45,1],[93,13,93,45,1],[93,13,93,45,1],[93,13,93,45,1],[93,13,93,45,1],[95,13,95,58,1],[95,13,95,58,1],[95,13,95,58,1],[95,13,95,58,1],[95,13,95,58,1],[96,13,96,14,1],[96,13,96,14,1],[96,13,96,14,1],[96,13,96,14,1],[96,13,96,14,1],[97,17,97,34,1],[97,17,97,34,1],[97,17,97,34,1],[97,17,97,34,1],[97,17,97,34,1],[100,13,100,48,1],[100,13,100,48,1],[100,13,100,48,1],[100,13,100,48,1],[100,13,100,48,1],[102,20,102,66,1],[102,20,102,66,1],[102,20,102,66,1],[102,20,102,66,1],[102,20,102,66,1],[102,68,102,84,1],[102,68,102,84,1],[102,68,102,84,1],[102,68,102,84,1],[102,68,102,84,1],[103,13,103,14,1],[103,13,103,14,1],[103,13,103,14,1],[103,13,103,14,1],[103,13,103,14,1],[104,17,104,91,1],[104,17,104,91,1],[104,17,104,91,1],[104,17,104,91,1],[104,17,104,91,1],[105,13,105,14,1],[105,13,105,14,1],[105,13,105,14,1],[105,13,105,14,1],[105,13,105,14,1],[107,13,107,52,1],[107,13,107,52,1],[107,13,107,52,1],[107,13,107,52,1],[107,13,107,52,1],[109,13,109,30,1],[109,13,109,30,1],[109,13,109,30,1],[109,13,109,30,1],[109,13,109,30,1],[110,9,110,10,1],[110,9,110,10,1],[110,9,110,10,1],[110,9,110,10,1],[110,9,110,10,1]]);
    </script>
  </body>
</html>