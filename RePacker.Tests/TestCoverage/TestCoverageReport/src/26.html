<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker\Generator\Generators\ArrayGenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Reflection;
using System.Reflection.Emit;
using RePacker.Buffers;
using RePacker.Utils;
using Buffer = RePacker.Buffers.Buffer;

namespace RePacker.Builder
{
    internal class ArrayGenerator : IGenerator
    {
        public GeneratorType GeneratorType =&gt; GeneratorType.Object;
        public Type ForType =&gt; typeof(Array);

        MethodInfo serializeBlittableArrayMethod = typeof(BufferExt)
            .GetMethod(nameof(BufferExt.PackBlittableArray));
        MethodInfo serializeArrayMethod = typeof(PackerCollectionsExt)
            .GetMethod(nameof(PackerCollectionsExt.PackArray));

        MethodInfo deserializeBlittableArrayMethod = typeof(BufferExt)
            .GetMethod(nameof(BufferExt.UnpackUnmanagedArrayOut));
        MethodInfo deserializeArrayMethod = typeof(PackerCollectionsExt)
            .GetMethod(nameof(PackerCollectionsExt.UnpackArray));

        public void GenerateDeserializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            var elementType = fieldInfo.FieldType.GetElementType();

            int rank = fieldInfo.FieldType.GetArrayRank();

            if (rank == 1)
            {
                if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo) &amp;&amp; !typeInfo.IsDirectlyCopyable)
                {
                    ilGen.Emit(OpCodes.Ldarg_0);

                    ilGen.Emit(OpCodes.Ldloca_S, 0);
                    ilGen.Emit(OpCodes.Ldflda, fieldInfo);

                    var arrayUnpacker = deserializeArrayMethod.MakeGenericMethod(elementType);
                    ilGen.Emit(OpCodes.Call, arrayUnpacker);
                }
                else if (elementType.IsValueType || elementType.IsUnmanagedStruct())
                {
                    ilGen.Emit(OpCodes.Ldarg_0);

                    ilGen.Emit(OpCodes.Ldloca_S, 0);
                    ilGen.Emit(OpCodes.Ldflda, fieldInfo);

                    var arrayUnpacker = deserializeBlittableArrayMethod.MakeGenericMethod(elementType);
                    ilGen.Emit(OpCodes.Call, arrayUnpacker);
                }
                else
                {
                    ilGen.EmitLog($&quot;RePacker - Unpack: Array of type {fieldInfo.FieldType.Name} is not supported&quot;);
                }
            }
            else
            {
                MethodInfo unpackMethod = null;
                switch (rank)
                {
                    case 2:
                        unpackMethod = typeof(PackerCollectionsExt)
                            .GetMethod(nameof(PackerCollectionsExt.UnpackArray2D))
                            .MakeGenericMethod(elementType);
                        break;
                    case 3:
                        unpackMethod = typeof(PackerCollectionsExt)
                            .GetMethod(nameof(PackerCollectionsExt.UnpackArray3D))
                            .MakeGenericMethod(elementType);
                        break;
                    case 4:
                        unpackMethod = typeof(PackerCollectionsExt)
                            .GetMethod(nameof(PackerCollectionsExt.UnpackArray4D))
                            .MakeGenericMethod(elementType);
                        break;
                }

                if (unpackMethod == null)
                {
                    ilGen.EmitLog($&quot;RePacker - Unpack: Array of rank {rank} is not supported&quot;);
                    return;
                }

                if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo))
                {
                    ilGen.Emit(OpCodes.Ldarg_0);

                    ilGen.Emit(OpCodes.Ldloca_S, 0);
                    ilGen.Emit(OpCodes.Ldflda, fieldInfo);

                    ilGen.Emit(OpCodes.Call, unpackMethod);
                }
                else
                {
                    ilGen.EmitLog($&quot;RePacker - Unpack: Array of type {fieldInfo.FieldType.Name} is not supported&quot;);
                }
            }
        }

        public void GenerateSerializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            var elementType = fieldInfo.FieldType.GetElementType();

            int rank = fieldInfo.FieldType.GetArrayRank();

            if (rank == 1)
            {
                if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo) &amp;&amp; !typeInfo.IsDirectlyCopyable)
                {
                    ilGen.Emit(OpCodes.Ldarg_0);
                    ilGen.Emit(OpCodes.Ldarga_S, 1);
                    ilGen.Emit(OpCodes.Ldfld, fieldInfo);

                    var arraySerializer = serializeArrayMethod.MakeGenericMethod(elementType);
                    ilGen.Emit(OpCodes.Call, arraySerializer);
                }
                else if (elementType.IsValueType || elementType.IsUnmanagedStruct())
                {
                    ilGen.Emit(OpCodes.Ldarg_0);

                    ilGen.Emit(OpCodes.Ldarga_S, 1);
                    ilGen.Emit(OpCodes.Ldfld, fieldInfo);

                    var arraySerializer = serializeBlittableArrayMethod.MakeGenericMethod(elementType);
                    ilGen.Emit(OpCodes.Call, arraySerializer);
                }
                else
                {
                    ilGen.EmitLog($&quot;RePacker - Pack: Array of type {fieldInfo.FieldType.Name} is not supported&quot;);
                }
            }
            else
            {
                MethodInfo packMethod = null;
                switch (rank)
                {
                    case 2:
                        packMethod = typeof(PackerCollectionsExt)
                            .GetMethod(nameof(PackerCollectionsExt.PackArray2D))
                            .MakeGenericMethod(elementType);
                        break;
                    case 3:
                        packMethod = typeof(PackerCollectionsExt)
                            .GetMethod(nameof(PackerCollectionsExt.PackArray3D))
                            .MakeGenericMethod(elementType);
                        break;
                    case 4:
                        packMethod = typeof(PackerCollectionsExt)
                            .GetMethod(nameof(PackerCollectionsExt.PackArray4D))
                            .MakeGenericMethod(elementType);
                        break;
                }

                if (packMethod == null)
                {
                    ilGen.EmitLog($&quot;RePacker - Pack: Array of rank {rank} is not supported&quot;);
                    return;
                }

                if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo))
                {
                    ilGen.Emit(OpCodes.Ldarg_0);
                    ilGen.Emit(OpCodes.Ldarga_S, 1);
                    ilGen.Emit(OpCodes.Ldflda, fieldInfo);

                    ilGen.Emit(OpCodes.Call, packMethod);
                }
                else
                {
                    ilGen.EmitLog($&quot;RePacker - Pack: Array of type {fieldInfo.FieldType.Name} is not supported&quot;);
                }
            }
        }

        public void GenerateGetSizer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            var elementType = fieldInfo.FieldType.GetElementType();

            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo) &amp;&amp; !typeInfo.IsDirectlyCopyable)
            {
                var sizeMethod = typeof(PackerCollectionsExt)
                    .GetMethod(nameof(PackerCollectionsExt.SizeOfColleciton))
                    .MakeGenericMethod(elementType);

                ilGen.Emit(OpCodes.Ldarg_0);
                ilGen.Emit(OpCodes.Call, fieldInfo.FieldType.GetMethod(&quot;GetEnumerator&quot;));
                ilGen.Emit(OpCodes.Call, sizeMethod);
            }
            else
            {
                ilGen.Emit(OpCodes.Ldc_I4, 0);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,47,13,67,0],[13,47,13,67,0],[13,47,13,67,0],[13,47,13,67,0],[13,47,13,67,0],[14,32,14,45,0],[14,32,14,45,0],[14,32,14,45,0],[14,32,14,45,0],[14,32,14,45,0],[16,9,17,62,1],[16,9,17,62,1],[16,9,17,62,1],[16,9,17,62,1],[16,9,17,62,1],[18,9,19,64,1],[18,9,19,64,1],[18,9,19,64,1],[18,9,19,64,1],[18,9,19,64,1],[21,9,22,67,1],[21,9,22,67,1],[21,9,22,67,1],[21,9,22,67,1],[21,9,22,67,1],[23,9,24,66,1],[23,9,24,66,1],[23,9,24,66,1],[23,9,24,66,1],[23,9,24,66,1],[27,9,27,10,0],[27,9,27,10,0],[27,9,27,10,0],[27,9,27,10,0],[27,9,27,10,0],[28,13,28,68,0],[28,13,28,68,0],[28,13,28,68,0],[28,13,28,68,0],[28,13,28,68,0],[30,13,30,59,0],[30,13,30,59,0],[30,13,30,59,0],[30,13,30,59,0],[30,13,30,59,0],[32,13,32,27,0],[32,13,32,27,0],[32,13,32,27,0],[32,13,32,27,0],[32,13,32,27,0],[33,13,33,14,0],[33,13,33,14,0],[33,13,33,14,0],[33,13,33,14,0],[33,13,33,14,0],[34,17,34,109,0],[34,17,34,109,0],[34,17,34,109,0],[34,17,34,109,0],[34,17,34,109,0],[35,17,35,18,0],[35,17,35,18,0],[35,17,35,18,0],[35,17,35,18,0],[35,17,35,18,0],[36,21,36,49,0],[36,21,36,49,0],[36,21,36,49,0],[36,21,36,49,0],[36,21,36,49,0],[38,21,38,53,0],[38,21,38,53,0],[38,21,38,53,0],[38,21,38,53,0],[38,21,38,53,0],[39,21,39,59,0],[39,21,39,59,0],[39,21,39,59,0],[39,21,39,59,0],[39,21,39,59,0],[41,21,41,95,0],[41,21,41,95,0],[41,21,41,95,0],[41,21,41,95,0],[41,21,41,95,0],[42,21,42,61,0],[42,21,42,61,0],[42,21,42,61,0],[42,21,42,61,0],[42,21,42,61,0],[43,17,43,18,0],[43,17,43,18,0],[43,17,43,18,0],[43,17,43,18,0],[43,17,43,18,0],[44,22,44,85,0],[44,22,44,85,0],[44,22,44,85,0],[44,22,44,85,0],[44,22,44,85,0],[45,17,45,18,0],[45,17,45,18,0],[45,17,45,18,0],[45,17,45,18,0],[45,17,45,18,0],[46,21,46,49,0],[46,21,46,49,0],[46,21,46,49,0],[46,21,46,49,0],[46,21,46,49,0],[48,21,48,53,0],[48,21,48,53,0],[48,21,48,53,0],[48,21,48,53,0],[48,21,48,53,0],[49,21,49,59,0],[49,21,49,59,0],[49,21,49,59,0],[49,21,49,59,0],[49,21,49,59,0],[51,21,51,104,0],[51,21,51,104,0],[51,21,51,104,0],[51,21,51,104,0],[51,21,51,104,0],[52,21,52,61,0],[52,21,52,61,0],[52,21,52,61,0],[52,21,52,61,0],[52,21,52,61,0],[53,17,53,18,0],[53,17,53,18,0],[53,17,53,18,0],[53,17,53,18,0],[53,17,53,18,0],[55,17,55,18,0],[55,17,55,18,0],[55,17,55,18,0],[55,17,55,18,0],[55,17,55,18,0],[56,21,56,116,0],[56,21,56,116,0],[56,21,56,116,0],[56,21,56,116,0],[56,21,56,116,0],[57,17,57,18,0],[57,17,57,18,0],[57,17,57,18,0],[57,17,57,18,0],[57,17,57,18,0],[58,13,58,14,0],[58,13,58,14,0],[58,13,58,14,0],[58,13,58,14,0],[58,13,58,14,0],[60,13,60,14,0],[60,13,60,14,0],[60,13,60,14,0],[60,13,60,14,0],[60,13,60,14,0],[61,17,61,48,0],[61,17,61,48,0],[61,17,61,48,0],[61,17,61,48,0],[61,17,61,48,0],[62,17,62,30,0],[62,17,62,30,0],[62,17,62,30,0],[62,17,62,30,0],[62,17,62,30,0],[65,25,67,61,0],[65,25,67,61,0],[65,25,67,61,0],[65,25,67,61,0],[65,25,67,61,0],[68,25,68,31,0],[68,25,68,31,0],[68,25,68,31,0],[68,25,68,31,0],[68,25,68,31,0],[70,25,72,61,0],[70,25,72,61,0],[70,25,72,61,0],[70,25,72,61,0],[70,25,72,61,0],[73,25,73,31,0],[73,25,73,31,0],[73,25,73,31,0],[73,25,73,31,0],[73,25,73,31,0],[75,25,77,61,0],[75,25,77,61,0],[75,25,77,61,0],[75,25,77,61,0],[75,25,77,61,0],[78,25,78,31,0],[78,25,78,31,0],[78,25,78,31,0],[78,25,78,31,0],[78,25,78,31,0],[81,17,81,42,0],[81,17,81,42,0],[81,17,81,42,0],[81,17,81,42,0],[81,17,81,42,0],[82,17,82,18,0],[82,17,82,18,0],[82,17,82,18,0],[82,17,82,18,0],[82,17,82,18,0],[83,21,83,96,0],[83,21,83,96,0],[83,21,83,96,0],[83,21,83,96,0],[83,21,83,96,0],[84,21,84,28,0],[84,21,84,28,0],[84,21,84,28,0],[84,21,84,28,0],[84,21,84,28,0],[87,17,87,77,0],[87,17,87,77,0],[87,17,87,77,0],[87,17,87,77,0],[87,17,87,77,0],[88,17,88,18,0],[88,17,88,18,0],[88,17,88,18,0],[88,17,88,18,0],[88,17,88,18,0],[89,21,89,49,0],[89,21,89,49,0],[89,21,89,49,0],[89,21,89,49,0],[89,21,89,49,0],[91,21,91,53,0],[91,21,91,53,0],[91,21,91,53,0],[91,21,91,53,0],[91,21,91,53,0],[92,21,92,59,0],[92,21,92,59,0],[92,21,92,59,0],[92,21,92,59,0],[92,21,92,59,0],[94,21,94,60,0],[94,21,94,60,0],[94,21,94,60,0],[94,21,94,60,0],[94,21,94,60,0],[95,17,95,18,0],[95,17,95,18,0],[95,17,95,18,0],[95,17,95,18,0],[95,17,95,18,0],[97,17,97,18,0],[97,17,97,18,0],[97,17,97,18,0],[97,17,97,18,0],[97,17,97,18,0],[98,21,98,116,0],[98,21,98,116,0],[98,21,98,116,0],[98,21,98,116,0],[98,21,98,116,0],[99,17,99,18,0],[99,17,99,18,0],[99,17,99,18,0],[99,17,99,18,0],[99,17,99,18,0],[100,13,100,14,0],[100,13,100,14,0],[100,13,100,14,0],[100,13,100,14,0],[100,13,100,14,0],[101,9,101,10,0],[101,9,101,10,0],[101,9,101,10,0],[101,9,101,10,0],[101,9,101,10,0],[104,9,104,10,0],[104,9,104,10,0],[104,9,104,10,0],[104,9,104,10,0],[104,9,104,10,0],[105,13,105,68,0],[105,13,105,68,0],[105,13,105,68,0],[105,13,105,68,0],[105,13,105,68,0],[107,13,107,59,0],[107,13,107,59,0],[107,13,107,59,0],[107,13,107,59,0],[107,13,107,59,0],[109,13,109,27,0],[109,13,109,27,0],[109,13,109,27,0],[109,13,109,27,0],[109,13,109,27,0],[110,13,110,14,0],[110,13,110,14,0],[110,13,110,14,0],[110,13,110,14,0],[110,13,110,14,0],[111,17,111,109,0],[111,17,111,109,0],[111,17,111,109,0],[111,17,111,109,0],[111,17,111,109,0],[112,17,112,18,0],[112,17,112,18,0],[112,17,112,18,0],[112,17,112,18,0],[112,17,112,18,0],[113,21,113,49,0],[113,21,113,49,0],[113,21,113,49,0],[113,21,113,49,0],[113,21,113,49,0],[114,21,114,53,0],[114,21,114,53,0],[114,21,114,53,0],[114,21,114,53,0],[114,21,114,53,0],[115,21,115,58,0],[115,21,115,58,0],[115,21,115,58,0],[115,21,115,58,0],[115,21,115,58,0],[117,21,117,95,0],[117,21,117,95,0],[117,21,117,95,0],[117,21,117,95,0],[117,21,117,95,0],[118,21,118,63,0],[118,21,118,63,0],[118,21,118,63,0],[118,21,118,63,0],[118,21,118,63,0],[119,17,119,18,0],[119,17,119,18,0],[119,17,119,18,0],[119,17,119,18,0],[119,17,119,18,0],[120,22,120,85,0],[120,22,120,85,0],[120,22,120,85,0],[120,22,120,85,0],[120,22,120,85,0],[121,17,121,18,0],[121,17,121,18,0],[121,17,121,18,0],[121,17,121,18,0],[121,17,121,18,0],[122,21,122,49,0],[122,21,122,49,0],[122,21,122,49,0],[122,21,122,49,0],[122,21,122,49,0],[124,21,124,53,0],[124,21,124,53,0],[124,21,124,53,0],[124,21,124,53,0],[124,21,124,53,0],[125,21,125,58,0],[125,21,125,58,0],[125,21,125,58,0],[125,21,125,58,0],[125,21,125,58,0],[127,21,127,104,0],[127,21,127,104,0],[127,21,127,104,0],[127,21,127,104,0],[127,21,127,104,0],[128,21,128,63,0],[128,21,128,63,0],[128,21,128,63,0],[128,21,128,63,0],[128,21,128,63,0],[129,17,129,18,0],[129,17,129,18,0],[129,17,129,18,0],[129,17,129,18,0],[129,17,129,18,0],[131,17,131,18,0],[131,17,131,18,0],[131,17,131,18,0],[131,17,131,18,0],[131,17,131,18,0],[132,21,132,114,0],[132,21,132,114,0],[132,21,132,114,0],[132,21,132,114,0],[132,21,132,114,0],[133,17,133,18,0],[133,17,133,18,0],[133,17,133,18,0],[133,17,133,18,0],[133,17,133,18,0],[134,13,134,14,0],[134,13,134,14,0],[134,13,134,14,0],[134,13,134,14,0],[134,13,134,14,0],[136,13,136,14,0],[136,13,136,14,0],[136,13,136,14,0],[136,13,136,14,0],[136,13,136,14,0],[137,17,137,46,0],[137,17,137,46,0],[137,17,137,46,0],[137,17,137,46,0],[137,17,137,46,0],[138,17,138,30,0],[138,17,138,30,0],[138,17,138,30,0],[138,17,138,30,0],[138,17,138,30,0],[141,25,143,61,0],[141,25,143,61,0],[141,25,143,61,0],[141,25,143,61,0],[141,25,143,61,0],[144,25,144,31,0],[144,25,144,31,0],[144,25,144,31,0],[144,25,144,31,0],[144,25,144,31,0],[146,25,148,61,0],[146,25,148,61,0],[146,25,148,61,0],[146,25,148,61,0],[146,25,148,61,0],[149,25,149,31,0],[149,25,149,31,0],[149,25,149,31,0],[149,25,149,31,0],[149,25,149,31,0],[151,25,153,61,0],[151,25,153,61,0],[151,25,153,61,0],[151,25,153,61,0],[151,25,153,61,0],[154,25,154,31,0],[154,25,154,31,0],[154,25,154,31,0],[154,25,154,31,0],[154,25,154,31,0],[157,17,157,40,0],[157,17,157,40,0],[157,17,157,40,0],[157,17,157,40,0],[157,17,157,40,0],[158,17,158,18,0],[158,17,158,18,0],[158,17,158,18,0],[158,17,158,18,0],[158,17,158,18,0],[159,21,159,94,0],[159,21,159,94,0],[159,21,159,94,0],[159,21,159,94,0],[159,21,159,94,0],[160,21,160,28,0],[160,21,160,28,0],[160,21,160,28,0],[160,21,160,28,0],[160,21,160,28,0],[163,17,163,77,0],[163,17,163,77,0],[163,17,163,77,0],[163,17,163,77,0],[163,17,163,77,0],[164,17,164,18,0],[164,17,164,18,0],[164,17,164,18,0],[164,17,164,18,0],[164,17,164,18,0],[165,21,165,49,0],[165,21,165,49,0],[165,21,165,49,0],[165,21,165,49,0],[165,21,165,49,0],[166,21,166,53,0],[166,21,166,53,0],[166,21,166,53,0],[166,21,166,53,0],[166,21,166,53,0],[167,21,167,59,0],[167,21,167,59,0],[167,21,167,59,0],[167,21,167,59,0],[167,21,167,59,0],[169,21,169,58,0],[169,21,169,58,0],[169,21,169,58,0],[169,21,169,58,0],[169,21,169,58,0],[170,17,170,18,0],[170,17,170,18,0],[170,17,170,18,0],[170,17,170,18,0],[170,17,170,18,0],[172,17,172,18,0],[172,17,172,18,0],[172,17,172,18,0],[172,17,172,18,0],[172,17,172,18,0],[173,21,173,114,0],[173,21,173,114,0],[173,21,173,114,0],[173,21,173,114,0],[173,21,173,114,0],[174,17,174,18,0],[174,17,174,18,0],[174,17,174,18,0],[174,17,174,18,0],[174,17,174,18,0],[175,13,175,14,0],[175,13,175,14,0],[175,13,175,14,0],[175,13,175,14,0],[175,13,175,14,0],[176,9,176,10,0],[176,9,176,10,0],[176,9,176,10,0],[176,9,176,10,0],[176,9,176,10,0],[179,9,179,10,0],[179,9,179,10,0],[179,9,179,10,0],[179,9,179,10,0],[179,9,179,10,0],[180,13,180,68,0],[180,13,180,68,0],[180,13,180,68,0],[180,13,180,68,0],[180,13,180,68,0],[182,13,182,105,0],[182,13,182,105,0],[182,13,182,105,0],[182,13,182,105,0],[182,13,182,105,0],[183,13,183,14,0],[183,13,183,14,0],[183,13,183,14,0],[183,13,183,14,0],[183,13,183,14,0],[184,17,186,53,0],[184,17,186,53,0],[184,17,186,53,0],[184,17,186,53,0],[184,17,186,53,0],[188,17,188,45,0],[188,17,188,45,0],[188,17,188,45,0],[188,17,188,45,0],[188,17,188,45,0],[189,17,189,90,0],[189,17,189,90,0],[189,17,189,90,0],[189,17,189,90,0],[189,17,189,90,0],[190,17,190,54,0],[190,17,190,54,0],[190,17,190,54,0],[190,17,190,54,0],[190,17,190,54,0],[191,13,191,14,0],[191,13,191,14,0],[191,13,191,14,0],[191,13,191,14,0],[191,13,191,14,0],[193,13,193,14,0],[193,13,193,14,0],[193,13,193,14,0],[193,13,193,14,0],[193,13,193,14,0],[194,17,194,47,0],[194,17,194,47,0],[194,17,194,47,0],[194,17,194,47,0],[194,17,194,47,0],[195,13,195,14,0],[195,13,195,14,0],[195,13,195,14,0],[195,13,195,14,0],[195,13,195,14,0],[196,9,196,10,0],[196,9,196,10,0],[196,9,196,10,0],[196,9,196,10,0],[196,9,196,10,0]]);
    </script>
  </body>
</html>