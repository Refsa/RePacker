<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker.Unsafe\Buffer\Buffer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Runtime.InteropServices;
using System;
using System.Runtime.CompilerServices;
using RePacker.Utils;
using RePacker.Unsafe;

namespace RePacker.Buffers
{
    public class Buffer
    {
        byte[] array;
        public byte[] Array =&gt; array;

        int writeCursor;
        int readCursor;

        bool expand;

        public Buffer(int size, bool expand = false)
        {
            this.array = new byte[size];
            this.writeCursor = 0;
            this.readCursor = 0;
            this.expand = expand;
        }

        public Buffer(byte[] buffer, int offset = 0, bool expand = false)
        {
            this.writeCursor = offset;
            this.readCursor = 0;

            this.array = buffer;
            this.expand = expand;

            if (this.array == null)
            {
                throw new ArgumentNullException(&quot;Array on Buffer is null&quot;);
            }
        }

        public Buffer(Buffer buffer)
        {
            if (buffer == null)
            {
                throw new ArgumentNullException(&quot;Buffer is null&quot;);
            }

            this.writeCursor = buffer.writeCursor;
            this.readCursor = buffer.readCursor;

            this.array = buffer.array;

            if (this.array == null)
            {
                throw new ArgumentNullException(&quot;Array on Buffer is null&quot;);
            }
        }

        public unsafe void Copy(Buffer source)
        {
            int length = source.writeCursor;
            if (!CanWriteBytes(length))
            {
                throw new IndexOutOfRangeException(&quot;Cant copy Buffer, destination too small&quot;);
            }

            fixed (void* src = &amp;source.array[readCursor], dest = &amp;array[writeCursor])
            {
                System.Buffer.MemoryCopy(src, dest, length, length);
            }

            MoveWriteCursor(length);
        }

        public unsafe Buffer Clone()
        {
            var buffer = new Buffer(writeCursor);

            fixed (void* src = &amp;array[readCursor], dest = buffer.array)
            {
                System.Buffer.MemoryCopy(src, dest, writeCursor, writeCursor);
            }

            buffer.writeCursor = writeCursor;

            return buffer;
        }

        #region General
        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public void Flush()
        {
            for (int i = 0; i &lt; writeCursor; i++)
            {
                array[i] = 0;
            }
            Reset();
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public void Reset()
        {
            readCursor = 0;
            writeCursor = 0;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public int WriteCursor()
        {
            return writeCursor;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public int Length()
        {
            return writeCursor - readCursor;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public int ReadCursor()
        {
            return readCursor;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public int FreeSpace()
        {
            return array.Length - writeCursor;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public void SetReadCursor(int pos)
        {
            readCursor = pos;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public void SetWriteCursor(int pos)
        {
            writeCursor = pos;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public void MoveWriteCursor(int amount)
        {
            writeCursor += amount;

            if (writeCursor &gt; array.Length || writeCursor &lt; 0)
            {
                writeCursor -= amount;
                throw new IndexOutOfRangeException(&quot;Trying to move write cursor outside of buffer range&quot;);
            }
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public void MoveReadCursor(int amount)
        {
            readCursor += amount;

            if (readCursor &gt; array.Length || readCursor &lt; 0)
            {
                readCursor -= amount;
                throw new IndexOutOfRangeException(&quot;Trying to move read cursor outside of buffer range&quot;);
            }
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public bool CanWriteBytes(int count)
        {
            if (writeCursor + count &gt; array.Length)
            {
                if (!expand) return false;

                Expand&lt;byte&gt;(count);
            }

            return true;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public bool CanReadBytes(int count)
        {
            return readCursor + count &lt;= array.Length;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public unsafe bool CanWrite&lt;T&gt;(int count = 1) where T : unmanaged
        {
            if ((writeCursor + (count * sizeof(T))) &gt; array.Length)
            {
                if (!expand) return false;

                Expand&lt;T&gt;();
            }

            return true;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public unsafe bool CanRead&lt;T&gt;(int count = 1) where T : unmanaged
        {
            return (readCursor + (count * sizeof(T))) &lt;= array.Length;
        }
        #endregion

        #region Size
        unsafe void Expand&lt;T&gt;(int count = 1) where T : unmanaged
        {
            byte[] newBuffer = new byte[writeCursor + sizeof(T)];

            if (writeCursor &gt; 0)
            {
                fixed (void* src = array, dest = newBuffer)
                {
                    System.Buffer.MemoryCopy(src, dest, writeCursor, writeCursor);
                }
            }

            array = newBuffer;
        }
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,32,12,37,1],[12,32,12,37,1],[12,32,12,37,1],[12,32,12,37,1],[12,32,12,37,1],[19,9,19,53,1],[19,9,19,53,1],[19,9,19,53,1],[19,9,19,53,1],[19,9,19,53,1],[20,9,20,10,1],[20,9,20,10,1],[20,9,20,10,1],[20,9,20,10,1],[20,9,20,10,1],[21,13,21,41,1],[21,13,21,41,1],[21,13,21,41,1],[21,13,21,41,1],[21,13,21,41,1],[22,13,22,34,1],[22,13,22,34,1],[22,13,22,34,1],[22,13,22,34,1],[22,13,22,34,1],[23,13,23,33,1],[23,13,23,33,1],[23,13,23,33,1],[23,13,23,33,1],[23,13,23,33,1],[24,13,24,34,1],[24,13,24,34,1],[24,13,24,34,1],[24,13,24,34,1],[24,13,24,34,1],[25,9,25,10,1],[25,9,25,10,1],[25,9,25,10,1],[25,9,25,10,1],[25,9,25,10,1],[27,9,27,74,1],[27,9,27,74,1],[27,9,27,74,1],[27,9,27,74,1],[27,9,27,74,1],[28,9,28,10,1],[28,9,28,10,1],[28,9,28,10,1],[28,9,28,10,1],[28,9,28,10,1],[29,13,29,39,1],[29,13,29,39,1],[29,13,29,39,1],[29,13,29,39,1],[29,13,29,39,1],[30,13,30,33,1],[30,13,30,33,1],[30,13,30,33,1],[30,13,30,33,1],[30,13,30,33,1],[32,13,32,33,1],[32,13,32,33,1],[32,13,32,33,1],[32,13,32,33,1],[32,13,32,33,1],[33,13,33,34,1],[33,13,33,34,1],[33,13,33,34,1],[33,13,33,34,1],[33,13,33,34,1],[35,13,35,36,1],[35,13,35,36,1],[35,13,35,36,1],[35,13,35,36,1],[35,13,35,36,1],[36,13,36,14,0],[36,13,36,14,0],[36,13,36,14,0],[36,13,36,14,0],[36,13,36,14,0],[37,17,37,76,0],[37,17,37,76,0],[37,17,37,76,0],[37,17,37,76,0],[37,17,37,76,0],[39,9,39,10,1],[39,9,39,10,1],[39,9,39,10,1],[39,9,39,10,1],[39,9,39,10,1],[41,9,41,37,0],[41,9,41,37,0],[41,9,41,37,0],[41,9,41,37,0],[41,9,41,37,0],[42,9,42,10,0],[42,9,42,10,0],[42,9,42,10,0],[42,9,42,10,0],[42,9,42,10,0],[43,13,43,32,0],[43,13,43,32,0],[43,13,43,32,0],[43,13,43,32,0],[43,13,43,32,0],[44,13,44,14,0],[44,13,44,14,0],[44,13,44,14,0],[44,13,44,14,0],[44,13,44,14,0],[45,17,45,67,0],[45,17,45,67,0],[45,17,45,67,0],[45,17,45,67,0],[45,17,45,67,0],[48,13,48,51,0],[48,13,48,51,0],[48,13,48,51,0],[48,13,48,51,0],[48,13,48,51,0],[49,13,49,49,0],[49,13,49,49,0],[49,13,49,49,0],[49,13,49,49,0],[49,13,49,49,0],[51,13,51,39,0],[51,13,51,39,0],[51,13,51,39,0],[51,13,51,39,0],[51,13,51,39,0],[53,13,53,36,0],[53,13,53,36,0],[53,13,53,36,0],[53,13,53,36,0],[53,13,53,36,0],[54,13,54,14,0],[54,13,54,14,0],[54,13,54,14,0],[54,13,54,14,0],[54,13,54,14,0],[55,17,55,76,0],[55,17,55,76,0],[55,17,55,76,0],[55,17,55,76,0],[55,17,55,76,0],[57,9,57,10,0],[57,9,57,10,0],[57,9,57,10,0],[57,9,57,10,0],[57,9,57,10,0],[60,9,60,10,0],[60,9,60,10,0],[60,9,60,10,0],[60,9,60,10,0],[60,9,60,10,0],[61,13,61,45,0],[61,13,61,45,0],[61,13,61,45,0],[61,13,61,45,0],[61,13,61,45,0],[62,13,62,40,0],[62,13,62,40,0],[62,13,62,40,0],[62,13,62,40,0],[62,13,62,40,0],[63,13,63,14,0],[63,13,63,14,0],[63,13,63,14,0],[63,13,63,14,0],[63,13,63,14,0],[64,17,64,95,0],[64,17,64,95,0],[64,17,64,95,0],[64,17,64,95,0],[64,17,64,95,0],[67,20,67,57,0],[67,20,67,57,0],[67,20,67,57,0],[67,20,67,57,0],[67,20,67,57,0],[67,59,67,85,0],[67,59,67,85,0],[67,59,67,85,0],[67,59,67,85,0],[67,59,67,85,0],[68,13,68,14,0],[68,13,68,14,0],[68,13,68,14,0],[68,13,68,14,0],[68,13,68,14,0],[69,17,69,69,0],[69,17,69,69,0],[69,17,69,69,0],[69,17,69,69,0],[69,17,69,69,0],[70,13,70,14,0],[70,13,70,14,0],[70,13,70,14,0],[70,13,70,14,0],[70,13,70,14,0],[72,13,72,37,0],[72,13,72,37,0],[72,13,72,37,0],[72,13,72,37,0],[72,13,72,37,0],[73,9,73,10,0],[73,9,73,10,0],[73,9,73,10,0],[73,9,73,10,0],[73,9,73,10,0],[76,9,76,10,0],[76,9,76,10,0],[76,9,76,10,0],[76,9,76,10,0],[76,9,76,10,0],[77,13,77,50,0],[77,13,77,50,0],[77,13,77,50,0],[77,13,77,50,0],[77,13,77,50,0],[79,20,79,50,0],[79,20,79,50,0],[79,20,79,50,0],[79,20,79,50,0],[79,20,79,50,0],[79,52,79,71,0],[79,52,79,71,0],[79,52,79,71,0],[79,52,79,71,0],[79,52,79,71,0],[80,13,80,14,0],[80,13,80,14,0],[80,13,80,14,0],[80,13,80,14,0],[80,13,80,14,0],[81,17,81,79,0],[81,17,81,79,0],[81,17,81,79,0],[81,17,81,79,0],[81,17,81,79,0],[82,13,82,14,0],[82,13,82,14,0],[82,13,82,14,0],[82,13,82,14,0],[82,13,82,14,0],[84,13,84,46,0],[84,13,84,46,0],[84,13,84,46,0],[84,13,84,46,0],[84,13,84,46,0],[86,13,86,27,0],[86,13,86,27,0],[86,13,86,27,0],[86,13,86,27,0],[86,13,86,27,0],[87,9,87,10,0],[87,9,87,10,0],[87,9,87,10,0],[87,9,87,10,0],[87,9,87,10,0],[92,9,92,10,0],[92,9,92,10,0],[92,9,92,10,0],[92,9,92,10,0],[92,9,92,10,0],[93,18,93,27,0],[93,18,93,27,0],[93,18,93,27,0],[93,18,93,27,0],[93,18,93,27,0],[93,29,93,44,0],[93,29,93,44,0],[93,29,93,44,0],[93,29,93,44,0],[93,29,93,44,0],[93,46,93,49,0],[93,46,93,49,0],[93,46,93,49,0],[93,46,93,49,0],[93,46,93,49,0],[94,13,94,14,0],[94,13,94,14,0],[94,13,94,14,0],[94,13,94,14,0],[94,13,94,14,0],[95,17,95,30,0],[95,17,95,30,0],[95,17,95,30,0],[95,17,95,30,0],[95,17,95,30,0],[96,13,96,14,0],[96,13,96,14,0],[96,13,96,14,0],[96,13,96,14,0],[96,13,96,14,0],[97,13,97,21,0],[97,13,97,21,0],[97,13,97,21,0],[97,13,97,21,0],[97,13,97,21,0],[98,9,98,10,0],[98,9,98,10,0],[98,9,98,10,0],[98,9,98,10,0],[98,9,98,10,0],[102,9,102,10,1],[102,9,102,10,1],[102,9,102,10,1],[102,9,102,10,1],[102,9,102,10,1],[103,13,103,28,1],[103,13,103,28,1],[103,13,103,28,1],[103,13,103,28,1],[103,13,103,28,1],[104,13,104,29,1],[104,13,104,29,1],[104,13,104,29,1],[104,13,104,29,1],[104,13,104,29,1],[105,9,105,10,1],[105,9,105,10,1],[105,9,105,10,1],[105,9,105,10,1],[105,9,105,10,1],[109,9,109,10,1],[109,9,109,10,1],[109,9,109,10,1],[109,9,109,10,1],[109,9,109,10,1],[110,13,110,32,1],[110,13,110,32,1],[110,13,110,32,1],[110,13,110,32,1],[110,13,110,32,1],[111,9,111,10,1],[111,9,111,10,1],[111,9,111,10,1],[111,9,111,10,1],[111,9,111,10,1],[115,9,115,10,0],[115,9,115,10,0],[115,9,115,10,0],[115,9,115,10,0],[115,9,115,10,0],[116,13,116,45,0],[116,13,116,45,0],[116,13,116,45,0],[116,13,116,45,0],[116,13,116,45,0],[117,9,117,10,0],[117,9,117,10,0],[117,9,117,10,0],[117,9,117,10,0],[117,9,117,10,0],[121,9,121,10,1],[121,9,121,10,1],[121,9,121,10,1],[121,9,121,10,1],[121,9,121,10,1],[122,13,122,31,1],[122,13,122,31,1],[122,13,122,31,1],[122,13,122,31,1],[122,13,122,31,1],[123,9,123,10,1],[123,9,123,10,1],[123,9,123,10,1],[123,9,123,10,1],[123,9,123,10,1],[127,9,127,10,0],[127,9,127,10,0],[127,9,127,10,0],[127,9,127,10,0],[127,9,127,10,0],[128,13,128,47,0],[128,13,128,47,0],[128,13,128,47,0],[128,13,128,47,0],[128,13,128,47,0],[129,9,129,10,0],[129,9,129,10,0],[129,9,129,10,0],[129,9,129,10,0],[129,9,129,10,0],[133,9,133,10,0],[133,9,133,10,0],[133,9,133,10,0],[133,9,133,10,0],[133,9,133,10,0],[134,13,134,30,0],[134,13,134,30,0],[134,13,134,30,0],[134,13,134,30,0],[134,13,134,30,0],[135,9,135,10,0],[135,9,135,10,0],[135,9,135,10,0],[135,9,135,10,0],[135,9,135,10,0],[139,9,139,10,1],[139,9,139,10,1],[139,9,139,10,1],[139,9,139,10,1],[139,9,139,10,1],[140,13,140,31,1],[140,13,140,31,1],[140,13,140,31,1],[140,13,140,31,1],[140,13,140,31,1],[141,9,141,10,1],[141,9,141,10,1],[141,9,141,10,1],[141,9,141,10,1],[141,9,141,10,1],[145,9,145,10,1],[145,9,145,10,1],[145,9,145,10,1],[145,9,145,10,1],[145,9,145,10,1],[146,13,146,35,1],[146,13,146,35,1],[146,13,146,35,1],[146,13,146,35,1],[146,13,146,35,1],[148,13,148,63,1],[148,13,148,63,1],[148,13,148,63,1],[148,13,148,63,1],[148,13,148,63,1],[149,13,149,14,0],[149,13,149,14,0],[149,13,149,14,0],[149,13,149,14,0],[149,13,149,14,0],[150,17,150,39,0],[150,17,150,39,0],[150,17,150,39,0],[150,17,150,39,0],[150,17,150,39,0],[151,17,151,107,0],[151,17,151,107,0],[151,17,151,107,0],[151,17,151,107,0],[151,17,151,107,0],[153,9,153,10,1],[153,9,153,10,1],[153,9,153,10,1],[153,9,153,10,1],[153,9,153,10,1],[157,9,157,10,1],[157,9,157,10,1],[157,9,157,10,1],[157,9,157,10,1],[157,9,157,10,1],[158,13,158,34,1],[158,13,158,34,1],[158,13,158,34,1],[158,13,158,34,1],[158,13,158,34,1],[160,13,160,61,1],[160,13,160,61,1],[160,13,160,61,1],[160,13,160,61,1],[160,13,160,61,1],[161,13,161,14,0],[161,13,161,14,0],[161,13,161,14,0],[161,13,161,14,0],[161,13,161,14,0],[162,17,162,38,0],[162,17,162,38,0],[162,17,162,38,0],[162,17,162,38,0],[162,17,162,38,0],[163,17,163,106,0],[163,17,163,106,0],[163,17,163,106,0],[163,17,163,106,0],[163,17,163,106,0],[165,9,165,10,1],[165,9,165,10,1],[165,9,165,10,1],[165,9,165,10,1],[165,9,165,10,1],[169,9,169,10,0],[169,9,169,10,0],[169,9,169,10,0],[169,9,169,10,0],[169,9,169,10,0],[170,13,170,52,0],[170,13,170,52,0],[170,13,170,52,0],[170,13,170,52,0],[170,13,170,52,0],[171,13,171,14,0],[171,13,171,14,0],[171,13,171,14,0],[171,13,171,14,0],[171,13,171,14,0],[172,17,172,29,0],[172,17,172,29,0],[172,17,172,29,0],[172,17,172,29,0],[172,17,172,29,0],[172,30,172,43,0],[172,30,172,43,0],[172,30,172,43,0],[172,30,172,43,0],[172,30,172,43,0],[174,17,174,37,0],[174,17,174,37,0],[174,17,174,37,0],[174,17,174,37,0],[174,17,174,37,0],[175,13,175,14,0],[175,13,175,14,0],[175,13,175,14,0],[175,13,175,14,0],[175,13,175,14,0],[177,13,177,25,0],[177,13,177,25,0],[177,13,177,25,0],[177,13,177,25,0],[177,13,177,25,0],[178,9,178,10,0],[178,9,178,10,0],[178,9,178,10,0],[178,9,178,10,0],[178,9,178,10,0],[182,9,182,10,0],[182,9,182,10,0],[182,9,182,10,0],[182,9,182,10,0],[182,9,182,10,0],[183,13,183,55,0],[183,13,183,55,0],[183,13,183,55,0],[183,13,183,55,0],[183,13,183,55,0],[184,9,184,10,0],[184,9,184,10,0],[184,9,184,10,0],[184,9,184,10,0],[184,9,184,10,0],[188,9,188,10,1],[188,9,188,10,1],[188,9,188,10,1],[188,9,188,10,1],[188,9,188,10,1],[189,13,189,68,1],[189,13,189,68,1],[189,13,189,68,1],[189,13,189,68,1],[189,13,189,68,1],[190,13,190,14,1],[190,13,190,14,1],[190,13,190,14,1],[190,13,190,14,1],[190,13,190,14,1],[191,17,191,29,1],[191,17,191,29,1],[191,17,191,29,1],[191,17,191,29,1],[191,17,191,29,1],[191,30,191,43,1],[191,30,191,43,1],[191,30,191,43,1],[191,30,191,43,1],[191,30,191,43,1],[193,17,193,29,0],[193,17,193,29,0],[193,17,193,29,0],[193,17,193,29,0],[193,17,193,29,0],[194,13,194,14,0],[194,13,194,14,0],[194,13,194,14,0],[194,13,194,14,0],[194,13,194,14,0],[196,13,196,25,1],[196,13,196,25,1],[196,13,196,25,1],[196,13,196,25,1],[196,13,196,25,1],[197,9,197,10,1],[197,9,197,10,1],[197,9,197,10,1],[197,9,197,10,1],[197,9,197,10,1],[201,9,201,10,1],[201,9,201,10,1],[201,9,201,10,1],[201,9,201,10,1],[201,9,201,10,1],[202,13,202,71,1],[202,13,202,71,1],[202,13,202,71,1],[202,13,202,71,1],[202,13,202,71,1],[203,9,203,10,1],[203,9,203,10,1],[203,9,203,10,1],[203,9,203,10,1],[203,9,203,10,1],[208,9,208,10,0],[208,9,208,10,0],[208,9,208,10,0],[208,9,208,10,0],[208,9,208,10,0],[209,13,209,66,0],[209,13,209,66,0],[209,13,209,66,0],[209,13,209,66,0],[209,13,209,66,0],[211,13,211,33,0],[211,13,211,33,0],[211,13,211,33,0],[211,13,211,33,0],[211,13,211,33,0],[212,13,212,14,0],[212,13,212,14,0],[212,13,212,14,0],[212,13,212,14,0],[212,13,212,14,0],[213,24,213,41,0],[213,24,213,41,0],[213,24,213,41,0],[213,24,213,41,0],[213,24,213,41,0],[213,43,213,59,0],[213,43,213,59,0],[213,43,213,59,0],[213,43,213,59,0],[213,43,213,59,0],[214,17,214,18,0],[214,17,214,18,0],[214,17,214,18,0],[214,17,214,18,0],[214,17,214,18,0],[215,21,215,83,0],[215,21,215,83,0],[215,21,215,83,0],[215,21,215,83,0],[215,21,215,83,0],[216,17,216,18,0],[216,17,216,18,0],[216,17,216,18,0],[216,17,216,18,0],[216,17,216,18,0],[217,13,217,14,0],[217,13,217,14,0],[217,13,217,14,0],[217,13,217,14,0],[217,13,217,14,0],[219,13,219,31,0],[219,13,219,31,0],[219,13,219,31,0],[219,13,219,31,0],[219,13,219,31,0],[220,9,220,10,0],[220,9,220,10,0],[220,9,220,10,0],[220,9,220,10,0],[220,9,220,10,0]]);
    </script>
  </body>
</html>