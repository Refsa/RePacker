<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker\Generator\Generators\UnmanagedStructGenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Reflection;
using System.Reflection.Emit;
using RePacker.Buffers;
using RePacker.Unsafe;
using RePacker.Utils;
using Buffer = RePacker.Buffers.Buffer;

namespace RePacker.Builder
{
    internal class UnmanagedStructGenerator : IGenerator
    {
        public GeneratorType GeneratorType =&gt; GeneratorType.Struct;
        public Type ForType =&gt; null;

        MethodInfo bufferPack = typeof(BufferUtils).GetMethod(nameof(BufferUtils.Pack));
        MethodInfo bufferUnpack = typeof(BufferUtils).GetMethod(nameof(BufferUtils.Unpack));
        MethodInfo bufferPopGeneric = null;
        MethodInfo bufferPushGeneric = null;

        MethodInfo unsafeSizeOfMethod = typeof(UnsafeUtils).GetMethod(nameof(UnsafeUtils.SizeOf));

        public void GenerateDeserializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            Type[] parameters = new Type[1];

            ilGen.Emit(OpCodes.Ldarg_0);

            ilGen.Emit(OpCodes.Ldloca_S, 0);
            ilGen.Emit(OpCodes.Ldflda, fieldInfo);

            parameters[0] = fieldInfo.FieldType;
            bufferPopGeneric = bufferUnpack.MakeGenericMethod(parameters);
            ilGen.Emit(OpCodes.Call, bufferPopGeneric);
        }

        public void GenerateSerializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            Type[] parameters = new Type[1];

            ilGen.Emit(OpCodes.Ldarg_0);

            ilGen.Emit(OpCodes.Ldarga_S, 1);
            ilGen.Emit(OpCodes.Ldflda, fieldInfo);

            parameters[0] = fieldInfo.FieldType;
            bufferPushGeneric = bufferPack.MakeGenericMethod(parameters);
            ilGen.Emit(OpCodes.Call, bufferPushGeneric);
        }

        public void GenerateGetSizer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            var genMethod = unsafeSizeOfMethod.MakeGenericMethod(fieldInfo.FieldType);

            ilGen.Emit(OpCodes.Ldarga_S, 0);
            ilGen.Emit(OpCodes.Ldflda, fieldInfo);
            ilGen.Emit(OpCodes.Call, genMethod);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,47,14,67,0],[14,47,14,67,0],[14,47,14,67,0],[14,47,14,67,0],[14,47,14,67,0],[15,32,15,36,0],[15,32,15,36,0],[15,32,15,36,0],[15,32,15,36,0],[15,32,15,36,0],[17,9,17,89,1],[17,9,17,89,1],[17,9,17,89,1],[17,9,17,89,1],[17,9,17,89,1],[18,9,18,93,1],[18,9,18,93,1],[18,9,18,93,1],[18,9,18,93,1],[18,9,18,93,1],[19,9,19,44,1],[19,9,19,44,1],[19,9,19,44,1],[19,9,19,44,1],[19,9,19,44,1],[20,9,20,45,1],[20,9,20,45,1],[20,9,20,45,1],[20,9,20,45,1],[20,9,20,45,1],[22,9,22,99,1],[22,9,22,99,1],[22,9,22,99,1],[22,9,22,99,1],[22,9,22,99,1],[25,9,25,10,0],[25,9,25,10,0],[25,9,25,10,0],[25,9,25,10,0],[25,9,25,10,0],[26,13,26,45,0],[26,13,26,45,0],[26,13,26,45,0],[26,13,26,45,0],[26,13,26,45,0],[28,13,28,41,0],[28,13,28,41,0],[28,13,28,41,0],[28,13,28,41,0],[28,13,28,41,0],[30,13,30,45,0],[30,13,30,45,0],[30,13,30,45,0],[30,13,30,45,0],[30,13,30,45,0],[31,13,31,51,0],[31,13,31,51,0],[31,13,31,51,0],[31,13,31,51,0],[31,13,31,51,0],[33,13,33,49,0],[33,13,33,49,0],[33,13,33,49,0],[33,13,33,49,0],[33,13,33,49,0],[34,13,34,75,0],[34,13,34,75,0],[34,13,34,75,0],[34,13,34,75,0],[34,13,34,75,0],[35,13,35,56,0],[35,13,35,56,0],[35,13,35,56,0],[35,13,35,56,0],[35,13,35,56,0],[36,9,36,10,0],[36,9,36,10,0],[36,9,36,10,0],[36,9,36,10,0],[36,9,36,10,0],[39,9,39,10,0],[39,9,39,10,0],[39,9,39,10,0],[39,9,39,10,0],[39,9,39,10,0],[40,13,40,45,0],[40,13,40,45,0],[40,13,40,45,0],[40,13,40,45,0],[40,13,40,45,0],[42,13,42,41,0],[42,13,42,41,0],[42,13,42,41,0],[42,13,42,41,0],[42,13,42,41,0],[44,13,44,45,0],[44,13,44,45,0],[44,13,44,45,0],[44,13,44,45,0],[44,13,44,45,0],[45,13,45,51,0],[45,13,45,51,0],[45,13,45,51,0],[45,13,45,51,0],[45,13,45,51,0],[47,13,47,49,0],[47,13,47,49,0],[47,13,47,49,0],[47,13,47,49,0],[47,13,47,49,0],[48,13,48,74,0],[48,13,48,74,0],[48,13,48,74,0],[48,13,48,74,0],[48,13,48,74,0],[49,13,49,57,0],[49,13,49,57,0],[49,13,49,57,0],[49,13,49,57,0],[49,13,49,57,0],[50,9,50,10,0],[50,9,50,10,0],[50,9,50,10,0],[50,9,50,10,0],[50,9,50,10,0],[53,9,53,10,0],[53,9,53,10,0],[53,9,53,10,0],[53,9,53,10,0],[53,9,53,10,0],[54,13,54,87,0],[54,13,54,87,0],[54,13,54,87,0],[54,13,54,87,0],[54,13,54,87,0],[56,13,56,45,0],[56,13,56,45,0],[56,13,56,45,0],[56,13,56,45,0],[56,13,56,45,0],[57,13,57,51,0],[57,13,57,51,0],[57,13,57,51,0],[57,13,57,51,0],[57,13,57,51,0],[58,13,58,49,0],[58,13,58,49,0],[58,13,58,49,0],[58,13,58,49,0],[58,13,58,49,0],[59,9,59,10,0],[59,9,59,10,0],[59,9,59,10,0],[59,9,59,10,0],[59,9,59,10,0]]);
    </script>
  </body>
</html>