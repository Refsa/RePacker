<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker\Generator\Generators\IListGenerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Reflection;
using System.Reflection.Emit;
using RePacker.Buffers;
using RePacker.Utils;

namespace RePacker.Builder
{
    internal class IListGenerator : IGenerator
    {
        public GeneratorType GeneratorType =&gt; GeneratorType.Object;
        public Type ForType =&gt; typeof(IList&lt;&gt;);

        MethodInfo deserializeIListMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.UnpackIList));
        MethodInfo deserializeIListBlittableMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.UnpackIListBlittable));

        MethodInfo serializeIListMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.PackIList));
        MethodInfo serializeIListBlittableMethod = typeof(PackerCollectionsExt).GetMethod(nameof(PackerCollectionsExt.PackIListBlittable));

        public void GenerateDeserializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            ilGen.Emit(OpCodes.Ldarg_0);

            ilGen.Emit(OpCodes.Ldloca_S, 0);
            ilGen.Emit(OpCodes.Ldflda, fieldInfo);

            Type elementType = fieldInfo.FieldType.GenericTypeArguments[0];
            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo))
            {
                var listSerializer = deserializeIListMethod.MakeGenericMethod(elementType);
                ilGen.Emit(OpCodes.Call, listSerializer);
            }
            else if (elementType.IsValueType || (elementType.IsStruct() &amp;&amp; elementType.IsUnmanagedStruct()))
            {
                var arraySerializer = deserializeIListBlittableMethod.MakeGenericMethod(elementType);
                ilGen.Emit(OpCodes.Call, arraySerializer);
            }
            else
            {
                ilGen.Emit(OpCodes.Pop);
                ilGen.Emit(OpCodes.Pop);
                ilGen.EmitLog($&quot;RePacker - Unpack: Array of type {fieldInfo.FieldType.Name} is not supported&quot;);
                return;
            }
        }

        public void GenerateSerializer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            ilGen.Emit(OpCodes.Ldarg_0);

            ilGen.Emit(OpCodes.Ldarga_S, 1);
            ilGen.Emit(OpCodes.Ldfld, fieldInfo);

            Type elementType = fieldInfo.FieldType.GenericTypeArguments[0];
            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo))
            {
                var listSerializer = serializeIListMethod.MakeGenericMethod(elementType);
                ilGen.Emit(OpCodes.Call, listSerializer);
            }
            else if (elementType.IsValueType || (elementType.IsStruct() &amp;&amp; elementType.IsUnmanagedStruct()))
            {
                var arraySerializer = serializeIListBlittableMethod.MakeGenericMethod(elementType);
                ilGen.Emit(OpCodes.Call, arraySerializer);
            }
            else
            {
                ilGen.Emit(OpCodes.Pop);
                ilGen.Emit(OpCodes.Pop);
                ilGen.EmitLog($&quot;RePacker - Pack: IList of type {fieldInfo.FieldType.Name} is not supported&quot;);
            }
        }

        public void GenerateGetSizer(ILGenerator ilGen, FieldInfo fieldInfo)
        {
            var elementType = fieldInfo.FieldType.GetElementType();

            if (TypeCache.TryGetTypeInfo(elementType, out var typeInfo) &amp;&amp; !typeInfo.IsDirectlyCopyable)
            {
                var sizeMethod = typeof(PackerCollectionsExt)
                    .GetMethod(nameof(PackerCollectionsExt.SizeOfColleciton))
                    .MakeGenericMethod(elementType);

                ilGen.Emit(OpCodes.Ldarg_0);
                ilGen.Emit(OpCodes.Call, fieldInfo.FieldType.GetMethod(&quot;GetEnumerator&quot;));
                ilGen.Emit(OpCodes.Call, sizeMethod);
            }
            else
            {
                ilGen.Emit(OpCodes.Ldc_I4, 0);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,47,12,67,0],[12,47,12,67,0],[12,47,12,67,0],[12,47,12,67,0],[12,47,12,67,0],[13,32,13,47,0],[13,32,13,47,0],[13,32,13,47,0],[13,32,13,47,0],[13,32,13,47,0],[15,9,15,126,1],[15,9,15,126,1],[15,9,15,126,1],[15,9,15,126,1],[15,9,15,126,1],[16,9,16,144,1],[16,9,16,144,1],[16,9,16,144,1],[16,9,16,144,1],[16,9,16,144,1],[18,9,18,122,1],[18,9,18,122,1],[18,9,18,122,1],[18,9,18,122,1],[18,9,18,122,1],[19,9,19,140,1],[19,9,19,140,1],[19,9,19,140,1],[19,9,19,140,1],[19,9,19,140,1],[22,9,22,10,0],[22,9,22,10,0],[22,9,22,10,0],[22,9,22,10,0],[22,9,22,10,0],[23,13,23,41,0],[23,13,23,41,0],[23,13,23,41,0],[23,13,23,41,0],[23,13,23,41,0],[25,13,25,45,0],[25,13,25,45,0],[25,13,25,45,0],[25,13,25,45,0],[25,13,25,45,0],[26,13,26,51,0],[26,13,26,51,0],[26,13,26,51,0],[26,13,26,51,0],[26,13,26,51,0],[28,13,28,76,0],[28,13,28,76,0],[28,13,28,76,0],[28,13,28,76,0],[28,13,28,76,0],[29,13,29,73,0],[29,13,29,73,0],[29,13,29,73,0],[29,13,29,73,0],[29,13,29,73,0],[30,13,30,14,0],[30,13,30,14,0],[30,13,30,14,0],[30,13,30,14,0],[30,13,30,14,0],[31,17,31,92,0],[31,17,31,92,0],[31,17,31,92,0],[31,17,31,92,0],[31,17,31,92,0],[32,17,32,58,0],[32,17,32,58,0],[32,17,32,58,0],[32,17,32,58,0],[32,17,32,58,0],[33,13,33,14,0],[33,13,33,14,0],[33,13,33,14,0],[33,13,33,14,0],[33,13,33,14,0],[34,18,34,109,0],[34,18,34,109,0],[34,18,34,109,0],[34,18,34,109,0],[34,18,34,109,0],[35,13,35,14,0],[35,13,35,14,0],[35,13,35,14,0],[35,13,35,14,0],[35,13,35,14,0],[36,17,36,102,0],[36,17,36,102,0],[36,17,36,102,0],[36,17,36,102,0],[36,17,36,102,0],[37,17,37,59,0],[37,17,37,59,0],[37,17,37,59,0],[37,17,37,59,0],[37,17,37,59,0],[38,13,38,14,0],[38,13,38,14,0],[38,13,38,14,0],[38,13,38,14,0],[38,13,38,14,0],[40,13,40,14,0],[40,13,40,14,0],[40,13,40,14,0],[40,13,40,14,0],[40,13,40,14,0],[41,17,41,41,0],[41,17,41,41,0],[41,17,41,41,0],[41,17,41,41,0],[41,17,41,41,0],[42,17,42,41,0],[42,17,42,41,0],[42,17,42,41,0],[42,17,42,41,0],[42,17,42,41,0],[43,17,43,112,0],[43,17,43,112,0],[43,17,43,112,0],[43,17,43,112,0],[43,17,43,112,0],[44,17,44,24,0],[44,17,44,24,0],[44,17,44,24,0],[44,17,44,24,0],[44,17,44,24,0],[46,9,46,10,0],[46,9,46,10,0],[46,9,46,10,0],[46,9,46,10,0],[46,9,46,10,0],[49,9,49,10,0],[49,9,49,10,0],[49,9,49,10,0],[49,9,49,10,0],[49,9,49,10,0],[50,13,50,41,0],[50,13,50,41,0],[50,13,50,41,0],[50,13,50,41,0],[50,13,50,41,0],[52,13,52,45,0],[52,13,52,45,0],[52,13,52,45,0],[52,13,52,45,0],[52,13,52,45,0],[53,13,53,50,0],[53,13,53,50,0],[53,13,53,50,0],[53,13,53,50,0],[53,13,53,50,0],[55,13,55,76,0],[55,13,55,76,0],[55,13,55,76,0],[55,13,55,76,0],[55,13,55,76,0],[56,13,56,73,0],[56,13,56,73,0],[56,13,56,73,0],[56,13,56,73,0],[56,13,56,73,0],[57,13,57,14,0],[57,13,57,14,0],[57,13,57,14,0],[57,13,57,14,0],[57,13,57,14,0],[58,17,58,90,0],[58,17,58,90,0],[58,17,58,90,0],[58,17,58,90,0],[58,17,58,90,0],[59,17,59,58,0],[59,17,59,58,0],[59,17,59,58,0],[59,17,59,58,0],[59,17,59,58,0],[60,13,60,14,0],[60,13,60,14,0],[60,13,60,14,0],[60,13,60,14,0],[60,13,60,14,0],[61,18,61,109,0],[61,18,61,109,0],[61,18,61,109,0],[61,18,61,109,0],[61,18,61,109,0],[62,13,62,14,0],[62,13,62,14,0],[62,13,62,14,0],[62,13,62,14,0],[62,13,62,14,0],[63,17,63,100,0],[63,17,63,100,0],[63,17,63,100,0],[63,17,63,100,0],[63,17,63,100,0],[64,17,64,59,0],[64,17,64,59,0],[64,17,64,59,0],[64,17,64,59,0],[64,17,64,59,0],[65,13,65,14,0],[65,13,65,14,0],[65,13,65,14,0],[65,13,65,14,0],[65,13,65,14,0],[67,13,67,14,0],[67,13,67,14,0],[67,13,67,14,0],[67,13,67,14,0],[67,13,67,14,0],[68,17,68,41,0],[68,17,68,41,0],[68,17,68,41,0],[68,17,68,41,0],[68,17,68,41,0],[69,17,69,41,0],[69,17,69,41,0],[69,17,69,41,0],[69,17,69,41,0],[69,17,69,41,0],[70,17,70,110,0],[70,17,70,110,0],[70,17,70,110,0],[70,17,70,110,0],[70,17,70,110,0],[71,13,71,14,0],[71,13,71,14,0],[71,13,71,14,0],[71,13,71,14,0],[71,13,71,14,0],[72,9,72,10,0],[72,9,72,10,0],[72,9,72,10,0],[72,9,72,10,0],[72,9,72,10,0],[75,9,75,10,0],[75,9,75,10,0],[75,9,75,10,0],[75,9,75,10,0],[75,9,75,10,0],[76,13,76,68,0],[76,13,76,68,0],[76,13,76,68,0],[76,13,76,68,0],[76,13,76,68,0],[78,13,78,105,0],[78,13,78,105,0],[78,13,78,105,0],[78,13,78,105,0],[78,13,78,105,0],[79,13,79,14,0],[79,13,79,14,0],[79,13,79,14,0],[79,13,79,14,0],[79,13,79,14,0],[80,17,82,53,0],[80,17,82,53,0],[80,17,82,53,0],[80,17,82,53,0],[80,17,82,53,0],[84,17,84,45,0],[84,17,84,45,0],[84,17,84,45,0],[84,17,84,45,0],[84,17,84,45,0],[85,17,85,90,0],[85,17,85,90,0],[85,17,85,90,0],[85,17,85,90,0],[85,17,85,90,0],[86,17,86,54,0],[86,17,86,54,0],[86,17,86,54,0],[86,17,86,54,0],[86,17,86,54,0],[87,13,87,14,0],[87,13,87,14,0],[87,13,87,14,0],[87,13,87,14,0],[87,13,87,14,0],[89,13,89,14,0],[89,13,89,14,0],[89,13,89,14,0],[89,13,89,14,0],[89,13,89,14,0],[90,17,90,47,0],[90,17,90,47,0],[90,17,90,47,0],[90,17,90,47,0],[90,17,90,47,0],[91,13,91,14,0],[91,13,91,14,0],[91,13,91,14,0],[91,13,91,14,0],[91,13,91,14,0],[92,9,92,10,0],[92,9,92,10,0],[92,9,92,10,0],[92,9,92,10,0],[92,9,92,10,0]]);
    </script>
  </body>
</html>