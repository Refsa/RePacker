<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Refsa\Documents\repackage\csharp\RePacker\Serializer\BufferExt.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using RePacker.Buffers;
using RePacker.Unsafe;
using Buffer = RePacker.Buffers.Buffer;

namespace RePacker.Buffers
{
    public static class BufferExt
    {
        static uint ZERO_UINT = 0;
        static ulong ZERO_ULONG = 0;

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void PackString(this Buffer buffer, ref string str)
        {
            if (string.IsNullOrEmpty(str))
            {
                buffer.Pack(ref ZERO_ULONG);
                return;
            }

            int count = 0;
            if (buffer.Array != null)
            {
                count = StringHelper.CopyString(str, buffer.Array, buffer.WriteCursor() + sizeof(ulong));

                ulong c = (ulong)count;
                buffer.Pack(ref c);

                buffer.MoveWriteCursor(count);
            }
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static string UnpackString(this Buffer buffer)
        {
            buffer.Unpack(out ulong length);

            if (length == 0)
            {
                return &quot;&quot;;
            }

            int start = buffer.ReadCursor();

            if (buffer.Array != null)
            {
                string s = StringHelper.GetString(buffer.Array, start, (int)length);
                buffer.MoveReadCursor((int)length);
                return s;
            }

            return &quot;&quot;;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void UnpackString(this Buffer buffer, out string value)
        {
            value = UnpackString(buffer);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void PackDateTime(this Buffer buffer, ref DateTime value)
        {
            long ticks = value.Ticks;
            buffer.Pack(ref ticks);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void UnpackDateTime(this Buffer buffer, out DateTime value)
        {
            buffer.Unpack(out long ticks);
            value = new DateTime(ticks);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void PackTimeSpan(this Buffer buffer, ref TimeSpan value)
        {
            long ticks = value.Ticks;
            buffer.Pack(ref ticks);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void UnpackTimeSpan(this Buffer buffer, out TimeSpan value)
        {
            buffer.Unpack(out long ticks);
            value = new TimeSpan(ticks);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void PackEnum&lt;TEnum&gt;(this Buffer buffer, ref TEnum target) where TEnum : unmanaged, Enum
        {
            buffer.Pack(ref target);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static TEnum UnpackEnum&lt;TEnum&gt;(this Buffer buffer) where TEnum : unmanaged, Enum
        {
            buffer.Unpack(out TEnum value);
            return value;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void PackBlittableArray&lt;T&gt;(this Buffer buffer, T[] data) where T : unmanaged
        {
            buffer.PackArray(data);
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static T[] UnpackBlittableArray&lt;T&gt;(this Buffer buffer) where T : unmanaged
        {
            return buffer.UnpackArray&lt;T&gt;();
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public static void UnpackUnmanagedArrayOut&lt;T&gt;(this Buffer buffer, out T[] data) where T : unmanaged
        {
            data = buffer.UnpackArray&lt;T&gt;();
        }

        public static void PackKeyValuePair&lt;T1, T2&gt;(this Buffer buffer, ref KeyValuePair&lt;T1, T2&gt; value)
        {
            var k = value.Key;
            RePacking.Pack&lt;T1&gt;(buffer, ref k);

            var v = value.Value;
            RePacking.Pack&lt;T2&gt;(buffer, ref v);
        }

        public static void UnpackKeyValuePair&lt;T1, T2&gt;(this Buffer buffer, out KeyValuePair&lt;T1, T2&gt; value)
        {
            value = new KeyValuePair&lt;T1, T2&gt;(
                RePacking.Unpack&lt;T1&gt;(buffer),
                RePacking.Unpack&lt;T2&gt;(buffer)
            );
        }

        public static void PackNullable&lt;TValue&gt;(this Buffer buffer, ref Nullable&lt;TValue&gt; value) where TValue : unmanaged
        {
            bool hasValue = value.HasValue;
            buffer.Pack(ref hasValue);

            if (hasValue)
            {
                TValue v = value.Value;
                RePacking.Pack(buffer, ref v);
            }
        }

        public static void UnpackNullable&lt;TValue&gt;(this Buffer buffer, out Nullable&lt;TValue&gt; value) where TValue : unmanaged
        {
            buffer.Unpack&lt;bool&gt;(out bool hasValue);

            if (hasValue)
            {
                value = RePacking.Unpack&lt;TValue&gt;(buffer);
            }
            else
            {
                value = null;
            }
        }
    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,1],[18,9,18,10,1],[18,9,18,10,1],[18,9,18,10,1],[18,9,18,10,1],[19,13,19,43,1],[19,13,19,43,1],[19,13,19,43,1],[19,13,19,43,1],[19,13,19,43,1],[20,13,20,14,1],[20,13,20,14,1],[20,13,20,14,1],[20,13,20,14,1],[20,13,20,14,1],[21,17,21,45,1],[21,17,21,45,1],[21,17,21,45,1],[21,17,21,45,1],[21,17,21,45,1],[22,17,22,24,1],[22,17,22,24,1],[22,17,22,24,1],[22,17,22,24,1],[22,17,22,24,1],[25,13,25,27,1],[25,13,25,27,1],[25,13,25,27,1],[25,13,25,27,1],[25,13,25,27,1],[26,13,26,38,1],[26,13,26,38,1],[26,13,26,38,1],[26,13,26,38,1],[26,13,26,38,1],[27,13,27,14,1],[27,13,27,14,1],[27,13,27,14,1],[27,13,27,14,1],[27,13,27,14,1],[28,17,28,106,1],[28,17,28,106,1],[28,17,28,106,1],[28,17,28,106,1],[28,17,28,106,1],[30,17,30,40,1],[30,17,30,40,1],[30,17,30,40,1],[30,17,30,40,1],[30,17,30,40,1],[31,17,31,36,1],[31,17,31,36,1],[31,17,31,36,1],[31,17,31,36,1],[31,17,31,36,1],[33,17,33,47,1],[33,17,33,47,1],[33,17,33,47,1],[33,17,33,47,1],[33,17,33,47,1],[34,13,34,14,1],[34,13,34,14,1],[34,13,34,14,1],[34,13,34,14,1],[34,13,34,14,1],[35,9,35,10,1],[35,9,35,10,1],[35,9,35,10,1],[35,9,35,10,1],[35,9,35,10,1],[39,9,39,10,1],[39,9,39,10,1],[39,9,39,10,1],[39,9,39,10,1],[39,9,39,10,1],[40,13,40,45,1],[40,13,40,45,1],[40,13,40,45,1],[40,13,40,45,1],[40,13,40,45,1],[42,13,42,29,1],[42,13,42,29,1],[42,13,42,29,1],[42,13,42,29,1],[42,13,42,29,1],[43,13,43,14,1],[43,13,43,14,1],[43,13,43,14,1],[43,13,43,14,1],[43,13,43,14,1],[44,17,44,27,1],[44,17,44,27,1],[44,17,44,27,1],[44,17,44,27,1],[44,17,44,27,1],[47,13,47,45,1],[47,13,47,45,1],[47,13,47,45,1],[47,13,47,45,1],[47,13,47,45,1],[49,13,49,38,1],[49,13,49,38,1],[49,13,49,38,1],[49,13,49,38,1],[49,13,49,38,1],[50,13,50,14,1],[50,13,50,14,1],[50,13,50,14,1],[50,13,50,14,1],[50,13,50,14,1],[51,17,51,85,1],[51,17,51,85,1],[51,17,51,85,1],[51,17,51,85,1],[51,17,51,85,1],[52,17,52,52,1],[52,17,52,52,1],[52,17,52,52,1],[52,17,52,52,1],[52,17,52,52,1],[53,17,53,26,1],[53,17,53,26,1],[53,17,53,26,1],[53,17,53,26,1],[53,17,53,26,1],[56,13,56,23,0],[56,13,56,23,0],[56,13,56,23,0],[56,13,56,23,0],[56,13,56,23,0],[57,9,57,10,1],[57,9,57,10,1],[57,9,57,10,1],[57,9,57,10,1],[57,9,57,10,1],[61,9,61,10,1],[61,9,61,10,1],[61,9,61,10,1],[61,9,61,10,1],[61,9,61,10,1],[62,13,62,42,1],[62,13,62,42,1],[62,13,62,42,1],[62,13,62,42,1],[62,13,62,42,1],[63,9,63,10,1],[63,9,63,10,1],[63,9,63,10,1],[63,9,63,10,1],[63,9,63,10,1],[67,9,67,10,1],[67,9,67,10,1],[67,9,67,10,1],[67,9,67,10,1],[67,9,67,10,1],[68,13,68,38,1],[68,13,68,38,1],[68,13,68,38,1],[68,13,68,38,1],[68,13,68,38,1],[69,13,69,36,1],[69,13,69,36,1],[69,13,69,36,1],[69,13,69,36,1],[69,13,69,36,1],[70,9,70,10,1],[70,9,70,10,1],[70,9,70,10,1],[70,9,70,10,1],[70,9,70,10,1],[74,9,74,10,1],[74,9,74,10,1],[74,9,74,10,1],[74,9,74,10,1],[74,9,74,10,1],[75,13,75,43,1],[75,13,75,43,1],[75,13,75,43,1],[75,13,75,43,1],[75,13,75,43,1],[76,13,76,41,1],[76,13,76,41,1],[76,13,76,41,1],[76,13,76,41,1],[76,13,76,41,1],[77,9,77,10,1],[77,9,77,10,1],[77,9,77,10,1],[77,9,77,10,1],[77,9,77,10,1],[81,9,81,10,0],[81,9,81,10,0],[81,9,81,10,0],[81,9,81,10,0],[81,9,81,10,0],[82,13,82,38,0],[82,13,82,38,0],[82,13,82,38,0],[82,13,82,38,0],[82,13,82,38,0],[83,13,83,36,0],[83,13,83,36,0],[83,13,83,36,0],[83,13,83,36,0],[83,13,83,36,0],[84,9,84,10,0],[84,9,84,10,0],[84,9,84,10,0],[84,9,84,10,0],[84,9,84,10,0],[88,9,88,10,0],[88,9,88,10,0],[88,9,88,10,0],[88,9,88,10,0],[88,9,88,10,0],[89,13,89,43,0],[89,13,89,43,0],[89,13,89,43,0],[89,13,89,43,0],[89,13,89,43,0],[90,13,90,41,0],[90,13,90,41,0],[90,13,90,41,0],[90,13,90,41,0],[90,13,90,41,0],[91,9,91,10,0],[91,9,91,10,0],[91,9,91,10,0],[91,9,91,10,0],[91,9,91,10,0],[95,9,95,10,1],[95,9,95,10,1],[95,9,95,10,1],[95,9,95,10,1],[95,9,95,10,1],[96,13,96,37,1],[96,13,96,37,1],[96,13,96,37,1],[96,13,96,37,1],[96,13,96,37,1],[97,9,97,10,1],[97,9,97,10,1],[97,9,97,10,1],[97,9,97,10,1],[97,9,97,10,1],[101,9,101,10,1],[101,9,101,10,1],[101,9,101,10,1],[101,9,101,10,1],[101,9,101,10,1],[102,13,102,44,1],[102,13,102,44,1],[102,13,102,44,1],[102,13,102,44,1],[102,13,102,44,1],[103,13,103,26,1],[103,13,103,26,1],[103,13,103,26,1],[103,13,103,26,1],[103,13,103,26,1],[104,9,104,10,1],[104,9,104,10,1],[104,9,104,10,1],[104,9,104,10,1],[104,9,104,10,1],[108,9,108,10,1],[108,9,108,10,1],[108,9,108,10,1],[108,9,108,10,1],[108,9,108,10,1],[109,13,109,36,1],[109,13,109,36,1],[109,13,109,36,1],[109,13,109,36,1],[109,13,109,36,1],[110,9,110,10,1],[110,9,110,10,1],[110,9,110,10,1],[110,9,110,10,1],[110,9,110,10,1],[114,9,114,10,1],[114,9,114,10,1],[114,9,114,10,1],[114,9,114,10,1],[114,9,114,10,1],[115,13,115,44,1],[115,13,115,44,1],[115,13,115,44,1],[115,13,115,44,1],[115,13,115,44,1],[116,9,116,10,1],[116,9,116,10,1],[116,9,116,10,1],[116,9,116,10,1],[116,9,116,10,1],[120,9,120,10,1],[120,9,120,10,1],[120,9,120,10,1],[120,9,120,10,1],[120,9,120,10,1],[121,13,121,44,1],[121,13,121,44,1],[121,13,121,44,1],[121,13,121,44,1],[121,13,121,44,1],[122,9,122,10,1],[122,9,122,10,1],[122,9,122,10,1],[122,9,122,10,1],[122,9,122,10,1],[125,9,125,10,1],[125,9,125,10,1],[125,9,125,10,1],[125,9,125,10,1],[125,9,125,10,1],[126,13,126,31,1],[126,13,126,31,1],[126,13,126,31,1],[126,13,126,31,1],[126,13,126,31,1],[127,13,127,47,1],[127,13,127,47,1],[127,13,127,47,1],[127,13,127,47,1],[127,13,127,47,1],[129,13,129,33,1],[129,13,129,33,1],[129,13,129,33,1],[129,13,129,33,1],[129,13,129,33,1],[130,13,130,47,1],[130,13,130,47,1],[130,13,130,47,1],[130,13,130,47,1],[130,13,130,47,1],[131,9,131,10,1],[131,9,131,10,1],[131,9,131,10,1],[131,9,131,10,1],[131,9,131,10,1],[134,9,134,10,1],[134,9,134,10,1],[134,9,134,10,1],[134,9,134,10,1],[134,9,134,10,1],[135,13,138,15,1],[135,13,138,15,1],[135,13,138,15,1],[135,13,138,15,1],[135,13,138,15,1],[139,9,139,10,1],[139,9,139,10,1],[139,9,139,10,1],[139,9,139,10,1],[139,9,139,10,1],[142,9,142,10,1],[142,9,142,10,1],[142,9,142,10,1],[142,9,142,10,1],[142,9,142,10,1],[143,13,143,44,1],[143,13,143,44,1],[143,13,143,44,1],[143,13,143,44,1],[143,13,143,44,1],[144,13,144,39,1],[144,13,144,39,1],[144,13,144,39,1],[144,13,144,39,1],[144,13,144,39,1],[146,13,146,26,1],[146,13,146,26,1],[146,13,146,26,1],[146,13,146,26,1],[146,13,146,26,1],[147,13,147,14,1],[147,13,147,14,1],[147,13,147,14,1],[147,13,147,14,1],[147,13,147,14,1],[148,17,148,40,1],[148,17,148,40,1],[148,17,148,40,1],[148,17,148,40,1],[148,17,148,40,1],[149,17,149,47,1],[149,17,149,47,1],[149,17,149,47,1],[149,17,149,47,1],[149,17,149,47,1],[150,13,150,14,1],[150,13,150,14,1],[150,13,150,14,1],[150,13,150,14,1],[150,13,150,14,1],[151,9,151,10,1],[151,9,151,10,1],[151,9,151,10,1],[151,9,151,10,1],[151,9,151,10,1],[154,9,154,10,1],[154,9,154,10,1],[154,9,154,10,1],[154,9,154,10,1],[154,9,154,10,1],[155,13,155,52,1],[155,13,155,52,1],[155,13,155,52,1],[155,13,155,52,1],[155,13,155,52,1],[157,13,157,26,1],[157,13,157,26,1],[157,13,157,26,1],[157,13,157,26,1],[157,13,157,26,1],[158,13,158,14,1],[158,13,158,14,1],[158,13,158,14,1],[158,13,158,14,1],[158,13,158,14,1],[159,17,159,58,1],[159,17,159,58,1],[159,17,159,58,1],[159,17,159,58,1],[159,17,159,58,1],[160,13,160,14,1],[160,13,160,14,1],[160,13,160,14,1],[160,13,160,14,1],[160,13,160,14,1],[162,13,162,14,1],[162,13,162,14,1],[162,13,162,14,1],[162,13,162,14,1],[162,13,162,14,1],[163,17,163,30,1],[163,17,163,30,1],[163,17,163,30,1],[163,17,163,30,1],[163,17,163,30,1],[164,13,164,14,1],[164,13,164,14,1],[164,13,164,14,1],[164,13,164,14,1],[164,13,164,14,1],[165,9,165,10,1],[165,9,165,10,1],[165,9,165,10,1],[165,9,165,10,1],[165,9,165,10,1]]);
    </script>
  </body>
</html>